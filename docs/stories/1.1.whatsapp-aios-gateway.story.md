# Story 1.1: WhatsApp AIOS Gateway API

## Status

Done

## Executor Assignment

```yaml
executor: "@dev"
quality_gate: "@architect"
quality_gate_tools: ["code-review", "security-check"]
```

## Story

**As a** usu√°rio do AIOS,
**I want** enviar mensagens pelo WhatsApp para agentes AIOS especializados,
**so that** eu possa interagir com @dev, @qa, @architect e outros agentes diretamente pelo WhatsApp, onde o AIOS processa a mensagem e responde de volta via Evolution API usando a skill `enviar-msg-whatsapp`.

## Arquitetura do Fluxo

```
WhatsApp ‚Üí Evolution API (VPS) ‚Üí n8n (VPS)
                                      ‚Üì
                          POST /api/aios/agent (fire & forget)
                          apibr.giesel.com.br:3000
                                      ‚Üì
                              APIBR2 (PC local)
                              responde 202 imediatamente
                                      ‚Üì async
                              invoca `claude --print`
                              com contexto da mensagem
                                      ‚Üì
                           AIOS / Claude Code (PC local)
                           processa com agente correto
                                      ‚Üì
                        skill enviar-msg-whatsapp
                        ~/.claude/skills/ ou .claude/skills/
                                      ‚Üì
                        Evolution API (VPS) ‚Üí WhatsApp ‚úÖ
```

**Ponto-chave:** n8n entrega a mensagem e esquece. A resposta volta por caminho independente: AIOS ‚Üí skill ‚Üí Evolution API ‚Üí WhatsApp.

## Acceptance Criteria

1. `POST /api/aios/agent` aceita payload com `agent`, `message`, `from` (n√∫mero remetente) e `session_id`
2. A rota responde imediatamente `202 Accepted` com `{ status: "processing" }` ‚Äî n√£o bloqueia o n8n
3. O processamento ocorre de forma ass√≠ncrona: APIBR2 invoca `claude --print` com o prompt montado
4. O prompt enviado ao Claude inclui: agente selecionado, hist√≥rico de sess√£o (Redis), mensagem atual e instru√ß√£o para usar a skill `enviar-msg-whatsapp` para responder ao n√∫mero `from`
5. A rota √© protegida pela autentica√ß√£o existente (API Key)
6. O `session_id` mant√©m hist√≥rico de mensagens via Redis (TTL: 24h)
7. Suporte inicial aos agentes: `dev`, `qa`, `architect`, `pm`, `sm`, `analyst`
8. Se `agent` n√£o for informado, usa agente padr√£o `dev`
9. Erros de valida√ß√£o retornam 400 com mensagem clara (antes do 202)
10. A skill `enviar-msg-whatsapp` est√° dispon√≠vel em `/home/flaviofagundes/aios/.claude/skills/enviar-msg-whatsapp/skill.md`
11. Vari√°veis de ambiente lidas do `.env`: `ANTHROPIC_API_KEY`, `CLAUDE_CLI_PATH`, `AIOS_PROJECT_PATH`

## ü§ñ CodeRabbit Integration

> **CodeRabbit Integration**: Disabled
>
> CodeRabbit CLI n√£o est√° configurado. Valida√ß√£o via revis√£o manual.

## Tasks / Subtasks

- [x] **Task 1: Criar rota e controller** (AC: 1, 2, 5, 9)
  - [x] Criar `backend/src/routes/aios.js` com `POST /agent`
  - [x] Criar `backend/src/controllers/aiosController.js`
  - [x] Registrar rota em `backend/src/routes/api.js`
  - [x] Aplicar middleware de autentica√ß√£o existente
  - [x] Validar campos obrigat√≥rios: `message`, `from`

- [x] **Task 2: Criar service de processamento ass√≠ncrono** (AC: 3, 4, 6, 7, 8)
  - [x] Criar `backend/src/services/aiosService.js`
  - [x] Implementar invoca√ß√£o do `claude --print` como child_process
  - [x] Montar prompt completo com: agente, hist√≥rico Redis, mensagem, instru√ß√£o de resposta via skill
  - [x] Implementar gest√£o de hist√≥rico de sess√£o no Redis (TTL: 86400s)
  - [x] Definir mapeamento de agentes dispon√≠veis com descri√ß√£o de cada um

- [x] **Task 3: Montar o prompt para Claude Code** (AC: 4, 10)
  - [x] Incluir instru√ß√£o clara: "use a skill enviar-msg-whatsapp para responder ao n√∫mero {from}"
  - [x] Incluir hist√≥rico de conversa formatado
  - [x] Incluir persona do agente selecionado
  - [x] Testar invoca√ß√£o manual do `claude --print` com prompt de exemplo

- [x] **Task 4: Configurar vari√°veis de ambiente** (AC: 11)
  - [x] Adicionar ao `.env.example`:
    - `CLAUDE_CLI_PATH=/usr/local/bin/claude`
    - `AIOS_PROJECT_PATH=/home/flaviofagundes/aios`
  - [ ] Documentar no README

- [x] **Task 5: Testes**
  - [x] Criar `backend/src/tests/aios.test.js`
  - [x] Testar: valida√ß√£o de payload, resposta 202, invoca√ß√£o do child_process
  - [x] Mockar `child_process` e `CacheService`

- [ ] **Task 6: Configurar n8n Workflow** (fora do c√≥digo ‚Äî configura√ß√£o manual)
  - [ ] Webhook trigger: Evolution API ‚Üí n8n
  - [ ] Extrair: `message.conversation`, `key.remoteJid` (n√∫mero), identificar agente via prefixo (@dev, @qa...)
  - [ ] POST para `apibr.giesel.com.br:3000/api/aios/agent` com API Key
  - [ ] n8n n√£o precisa aguardar resposta (fire & forget)

## Dev Notes

### Arquitetura de invoca√ß√£o

O APIBR2 invoca o Claude Code CLI (`claude --print`) como subprocess, passando o prompt completo. O Claude Code processa, usa a skill `enviar-msg-whatsapp` e responde direto ao WhatsApp.

```javascript
const { exec } = require('child_process');

const prompt = buildPrompt(agent, history, message, from);
const cmd = `${CLAUDE_CLI_PATH} --print "${escapePrompt(prompt)}"`;

exec(cmd, { cwd: AIOS_PROJECT_PATH }, (err, stdout, stderr) => {
  // Log resultado ‚Äî resposta j√° foi enviada pela skill
  console.log('AIOS response sent:', stdout);
});
```

### Estrutura do prompt enviado ao Claude

```
Voc√™ √© o agente @{agent} do AIOS.

Hist√≥rico da conversa:
{history_formatado}

Nova mensagem de {from}:
{message}

IMPORTANTE: Ap√≥s processar, use a skill enviar-msg-whatsapp para enviar
sua resposta ao n√∫mero {from}. N√ÉO responda aqui no terminal, APENAS
via skill.
```

### Padr√£o de arquitetura do APIBR2

```
routes/         ‚Üí define endpoints, aplica middlewares
controllers/    ‚Üí valida request, chama service, formata response
services/       ‚Üí l√≥gica de neg√≥cio, integra√ß√µes externas
```

### Autentica√ß√£o existente

Middleware em `backend/src/middlewares/` ‚Äî aplicar o mesmo usado em outras rotas (API Key header).

### Redis ‚Äî Gest√£o de sess√£o

O `CacheService` j√° existe em `backend/src/infrastructure/`. Usar para:
```javascript
// Salvar hist√≥rico
await cacheService.set(`aios:session:${sessionId}`, messages, 86400);
// Buscar hist√≥rico
const messages = await cacheService.get(`aios:session:${sessionId}`);
```

### Skill de envio

Localiza√ß√£o no AIOS: `/home/flaviofagundes/aios/.claude/skills/enviar-msg-whatsapp/skill.md`

Requer vari√°veis de ambiente no sistema:
- `EVOLUTION_API_BASE_URL`
- `EVOLUTION_API_KEY`
- `EVOLUTION_INSTANCE`

### Payload esperado do n8n

```json
POST /api/aios/agent
{
  "agent": "dev",
  "message": "@dev como implemento autentica√ß√£o JWT?",
  "from": "5511999999999",
  "session_id": "5511999999999"
}
```

### Resposta imediata ao n8n (202)

```json
{
  "status": "processing",
  "session_id": "5511999999999",
  "agent": "dev"
}
```

### Identifica√ß√£o autom√°tica do agente (opcional no n8n)

O n8n pode extrair o agente da mensagem se o usu√°rio escrever `@dev`, `@qa`, etc. no in√≠cio. Ou o fluxo n8n pode ter agente fixo por n√∫mero/grupo.

### Testing

- Framework: Jest (j√° configurado no projeto)
- Localiza√ß√£o: `backend/tests/aios.test.js`
- Mockar `child_process.exec` e `CacheService`
- Testar valida√ß√£o de payload e resposta 202

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-13 | 1.0.0 | Story criada ‚Äî Draft inicial | Orion (aios-master) |
| 2026-02-13 | 1.1.0 | Arquitetura revisada: resposta via AIOS skill (n√£o APIBR2), fire & forget, claude --print | Orion (aios-master) |

## Dev Agent Record

*(Preenchido pelo @dev durante implementa√ß√£o)*

### Agent Model Used

claude-haiku-4-5-20251001 (Dex/@dev)

### Debug Log References

- jest.config.json: removidos campos inv√°lidos `type` e `preset`
- Teste movido para `src/tests/` (padr√£o do projeto)

### Completion Notes

- 8/8 testes passando ‚úÖ
- `claude` CLI encontrado em `/usr/local/bin/claude`
- Arquitetura final: APIBR2 captura stdout do claude --print e envia via Evolution API (axios)
- Ciclo completo testado e validado: WhatsApp ‚Üí n8n ‚Üí APIBR2 ‚Üí Claude ‚Üí Evolution API ‚Üí WhatsApp ‚úÖ
- Task 6 (n8n workflow) √© configura√ß√£o manual fora do c√≥digo

### File List

- `backend/src/routes/aios.js` ‚Äî novo
- `backend/src/controllers/aiosController.js` ‚Äî novo
- `backend/src/services/aiosService.js` ‚Äî novo
- `backend/src/services/aiosAgentPrompts.js` ‚Äî novo
- `backend/src/tests/aios.test.js` ‚Äî novo
- `backend/.env.example` ‚Äî modificado
- `backend/src/routes/api.js` ‚Äî modificado
- `backend/jest.config.json` ‚Äî corrigido

## QA Results

*(Preenchido pelo @qa ap√≥s revis√£o)*

_
