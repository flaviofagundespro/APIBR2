# Story 1.2: Smart Agent Router ‚Äî Roteamento Inteligente de Mensagens

## Status

Done

## Executor Assignment

```yaml
executor: "@dev"
quality_gate: "@architect"
quality_gate_tools: ["code-review"]
```

## Story

**As a** usu√°rio do WhatsApp,
**I want** enviar mensagens naturalmente sem precisar especificar o agente,
**so that** o AIOS identifique automaticamente qual agente deve responder ‚Äî seja por `@men√ß√£o`, pelo nome do agente, ou por an√°lise inteligente da inten√ß√£o da mensagem.

## Arquitetura do Roteamento

```
Mensagem recebida
        ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Passo 1: Prefix Detection  ‚îÇ
‚îÇ  "@dev", "@qa", "@architect"‚îÇ ‚Üí agente identificado
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
        ‚Üì (n√£o encontrou)
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Passo 2: Name Detection    ‚îÇ
‚îÇ  "Dex,", "Quinn,", "Alex,"  ‚îÇ ‚Üí agente identificado
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
        ‚Üì (n√£o encontrou)
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Passo 3: Claude Auto-Route ‚îÇ
‚îÇ  Classifica inten√ß√£o        ‚îÇ ‚Üí agente mais adequado
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
        ‚Üì
   Processa com agente
   escolhido + responde
```

## Mapeamento de Nomes e Prefixos

| Agente | Prefixo | Nome | Especialidade |
|--------|---------|------|---------------|
| dev | @dev | Dex | c√≥digo, bugs, implementa√ß√£o |
| qa | @qa | Quinn | testes, qualidade, review |
| architect | @architect | Alex | arquitetura, design, padr√µes |
| pm | @pm | Morgan | produto, requisitos, roadmap |
| sm | @sm | River | hist√≥rias, sprints, processos |
| analyst | @analyst | Sam | dados, pesquisa, an√°lise |

## Acceptance Criteria

1. Se a mensagem cont√©m `@agente` (ex: `@dev`, `@qa`), usa esse agente diretamente
2. Se a mensagem come√ßa com o nome do agente seguido de v√≠rgula (ex: `Dex,`, `Quinn,`), usa esse agente
3. Se nenhum dos anteriores, Claude classifica a inten√ß√£o e escolhe o agente mais adequado
4. O campo `agent` no payload passa a ser **opcional** ‚Äî se enviado, tem prioridade sobre tudo
5. O agente escolhido √© inclu√≠do na resposta de volta ao WhatsApp (ex: "üë®‚Äçüíª *Dex (Dev)*: sua resposta...")
6. Se a classifica√ß√£o autom√°tica falhar, usa `dev` como fallback
7. O roteamento autom√°tico via Claude usa chamada leve (max_tokens: 100) ‚Äî s√≥ para classificar
8. Logs indicam qual m√©todo de roteamento foi usado (prefix/name/auto)

## ü§ñ CodeRabbit Integration

> **CodeRabbit Integration**: Disabled. Valida√ß√£o via revis√£o manual.

## Tasks / Subtasks

- [x] **Task 1: Criar AiosRouter service** (AC: 1, 2, 3, 4, 6, 8)
  - [x] Criar `backend/src/services/aiosRouter.js`
  - [x] Implementar `detectByPrefix(message)` ‚Äî extrai `@agente`
  - [x] Implementar `detectByName(message)` ‚Äî detecta "Nome," no in√≠cio
  - [x] Implementar `detectByIntent(message)` ‚Äî chama Claude para classificar
  - [x] Implementar `route(message, agentOverride)` ‚Äî orquestra os 3 passos

- [x] **Task 2: Integrar router no controller e service** (AC: 4, 5)
  - [x] Atualizar `aiosController.js`: campo `agent` vira opcional
  - [x] Chamar `aiosRouter.route()` antes de processar
  - [x] Atualizar `aiosService.js`: prefixar resposta com identidade do agente

- [x] **Task 3: Implementar classifica√ß√£o via Claude** (AC: 3, 7)
  - [x] Prompt de classifica√ß√£o compacto (retorna apenas o nome do agente)
  - [x] Usar Anthropic SDK diretamente (n√£o via CLI ‚Äî √© r√°pido e leve)
  - [x] Fallback gracioso quando ANTHROPIC_API_KEY n√£o configurada

- [x] **Task 4: Testes** (AC: 1, 2, 3, 6)
  - [x] Criar `backend/src/tests/aiosRouter.test.js`
  - [x] Testar: prefix detection, name detection, auto-routing, fallback
  - [x] Mockar chamada Claude de classifica√ß√£o

## Dev Notes

### Estrutura do AiosRouter

```javascript
// backend/src/services/aiosRouter.js

const AGENT_PREFIXES = {
  '@dev': 'dev', '@qa': 'qa', '@architect': 'architect',
  '@pm': 'pm', '@sm': 'sm', '@analyst': 'analyst'
};

const AGENT_NAMES = {
  'dex': 'dev', 'quinn': 'qa', 'alex': 'architect',
  'morgan': 'pm', 'river': 'sm', 'sam': 'analyst'
};

export class AiosRouter {
  async route(message, agentOverride = null) {
    // 1. Override expl√≠cito no payload tem prioridade
    if (agentOverride && VALID_AGENTS.includes(agentOverride)) return agentOverride;
    // 2. Prefix detection (@dev, @qa...)
    // 3. Name detection (Dex,, Quinn,...)
    // 4. Auto-route via Claude
    // 5. Fallback: 'dev'
  }
}
```

### Prompt de Classifica√ß√£o (leve)

```
Classifique a inten√ß√£o desta mensagem e responda com APENAS UMA PALAVRA:
dev | qa | architect | pm | sm | analyst

Regras:
- dev: c√≥digo, implementa√ß√£o, bug, endpoint, fun√ß√£o, banco de dados
- qa: teste, qualidade, review, bug report, valida√ß√£o
- architect: arquitetura, padr√£o, design, escalabilidade, decis√£o t√©cnica
- pm: produto, feature, requisito, roadmap, prioridade
- sm: hist√≥ria, sprint, processo, estimativa, retrospectiva
- analyst: dados, pesquisa, an√°lise, relat√≥rio, benchmark

Mensagem: "{message}"

Resposta (apenas uma palavra):
```

### Prefixo na resposta ao WhatsApp

```javascript
const AGENT_SIGNATURE = {
  dev: 'üë®‚Äçüíª *Dex (Dev)*',
  qa: 'üîç *Quinn (QA)*',
  architect: 'üèõÔ∏è *Alex (Architect)*',
  pm: 'üìã *Morgan (PM)*',
  sm: 'üîÑ *River (SM)*',
  analyst: 'üìä *Sam (Analyst)*',
};

const formattedResponse = `${AGENT_SIGNATURE[agent]}:\n\n${response}`;
```

### Integra√ß√£o com Anthropic SDK para classifica√ß√£o

```javascript
import Anthropic from '@anthropic-ai/sdk';

const client = new Anthropic({ apiKey: process.env.ANTHROPIC_API_KEY });

const result = await client.messages.create({
  model: 'claude-haiku-4-5-20251001', // modelo mais r√°pido e barato
  max_tokens: 10,
  messages: [{ role: 'user', content: classificationPrompt }]
});
```

### Depend√™ncia necess√°ria

```bash
npm install @anthropic-ai/sdk
```

Adicionar `ANTHROPIC_API_KEY=` no `.env`.

### Testing

- Framework: Jest (j√° configurado)
- Localiza√ß√£o: `backend/src/tests/aiosRouter.test.js`
- Mockar Anthropic SDK para classifica√ß√£o
- Testar os 4 caminhos de roteamento

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-13 | 1.0.0 | Story criada | Dex/@dev (aios-master context) |

## Dev Agent Record

*(Preenchido pelo @dev durante implementa√ß√£o)*

### Agent Model Used
_

### Debug Log References
_

### Completion Notes
_

### File List

- `backend/src/services/aiosRouter.js` ‚Äî novo
- `backend/src/controllers/aiosController.js` ‚Äî modificado
- `backend/src/services/aiosService.js` ‚Äî modificado
- `backend/src/tests/aiosRouter.test.js` ‚Äî novo
- `backend/.env` ‚Äî modificado (ANTHROPIC_API_KEY)

## QA Results

*(Preenchido pelo @qa ap√≥s revis√£o)*
_
